<!DOCTYPE html>
<html lang='en'>
<head>
    <title>Send ETH With Metamask</title>
    <script src='bundle.js' type='text/javascript'></script>
    <script>
        let yourAccount
        const value = web3.toWei('0.01', 'ether')
        const gasPrice = web3.toHex(web3.toWei('4','gwei'))
        const weiValueInHex = web3.toHex(value)
        const desiredNetwork = '3' // Ropsten

        function runMetaMask() {
            util.message("Loading MetaMask")


            if (typeof window.ethereum == 'undefined') {
                util.message('No MetaMask browser extension present')
            } else {
                ethereum.enable()
                    .catch(function (reason) {
                        util.message(`Rejection reason: ${reason}`)
                    })

                    .then(function (accounts) {
                        if (ethereum.networkVersion !== desiredNetwork) {
                            util.message('Switch network to Ropsten in the MetaMask UI')
                        }

                        yourAccount = accounts[0]
                        util.message(`Wallet Address: ${yourAccount}`)
                        web3.eth.getBalance(yourAccount, function(err, balance) {
                            util.message(`Balance: ${web3.fromWei(balance, "ether")} ETH`)
                        })
                        sendEtherFrom(yourAccount, function (err, transaction) {
                            if (err) {
                                return util.message(`Could not pay: ${err}`)
                            }
                            util.message(`Payment sent: ${util.pretty(transaction)}`)
                        })
                    })
            }
        }

        function sendEtherFrom(account, callback) {
            const method = 'eth_sendTransaction'
            const parameters = [{
                from: yourAccount,
                to: yourAccount,
                gasPrice: gasPrice,
                value: weiValueInHex,
                //data: '0x0000000000000001' // message / function call to a smart contract
            }]

            const from = account
            const payload = {
                method: method,
                params: parameters,
                from: from,
            }

            ethereum.sendAsync(payload, function (err, response) {
                if (response.error) {
                    util.message(`Rejected: ${response.error.message}`)
                }
                if (response.result) {
                    const txHash = response.result
                    util.message(`Paid transaction: ${txHash}`)
                    util.message(`Payment details:<br />${util.pretty(payload)}`)
                    pollForCompletion(txHash, callback)
                }
            })
        }

        function pollForCompletion(txHash, callback) {
            let calledBack = false
            const checkInterval = setInterval(function () {
                const notYet = 'response has no error or result'
                ethereum.sendAsync({
                    method: 'eth_getTransactionByHash',
                    params: [txHash],
                }, function (err, response) {
                    if (calledBack) return
                    if (err || response.error) {
                        if (err.message.includes(notYet)) {
                            return 'transactiion is not yet mined'
                        }

                        callback(err || response.error)
                    }

                    const transaction = response.result
                    clearInterval(checkInterval)
                    calledBack = true
                    callback(null, transaction)
                })
            }, 2000)
        }
        document.addEventListener('DOMContentLoaded', runMetaMask)
    </script>
</head>

<body id='messages'>

</body>