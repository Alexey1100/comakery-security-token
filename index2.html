<!DOCTYPE html>

<head>
    <title>MetaMask Example</title>
    <script>
        const yourAddress = '0xAE7Ab36ABAeFD0f0bB245494Ce14406a6b8fC9d6';
        const value = '0x1'; //0.1 ETH in Wei
        const desiredNetwork = '3'; // Ropsten
        
        function message(message) {
            var elem = document.querySelector("#messages");
            elem.innerHTML += message;
            elem.innerHTML += '<br />'
        }

        function runMetaMask() {
            message("Loading MetaMask");


            if (typeof window.ethereum == 'undefined') {
                message('No MetaMask browser extension present');
            } else {
                ethereum.enable()
                    .catch(function (reason) {
                        message(`Rejection reason: ${reason}`)
                    })

                    .then(function (accounts) {
                        if (ethereum.networkVersion !== desiredNetwork) {
                            message('Swith network to Ropesten in the MetaMask UI')
                        }

                        const account = accounts[0]
                        sendEtherFrom(account, function (err, transaction) {
                            if (err) {
                                return message(`Could not pay: ${err}`);
                            }
                            message(`Thanks for paying transaction: ${transaction}`);
                        })
                    })
            }
        }

        function sendEtherFrom(account, callback) {
            const method = 'eth_sendTransaction'
            const parameters = [{
                from: account,
                to: yourAddress,
                value: value,
            }]

            const from = account;
            const payload = {
                method: method,
                params: parameters,
                from: from,
            }

            ethereum.sendAsync(payload, function (err, response) {
                if (response.error) {
                    message(`Rejected: ${response.error.message}`);
                }
                if (response.result) {
                    const txHash = response.result;
                    message(`Paid trransaction: ${txHash}`);
                    pollForCompletion(txHash, callaback);
                }
            })
        }

        function pollForCompletion(txHash, callback) {
            let calledBack = false;
            const checkInterval = setInterval(function () {
                const notYet = 'response has no error or result';
                ethereum.sendAsync({
                    method: 'eth_getTransactionByHash',
                    params: [txHash],
                }, function (err, response) {
                    if (calledBack) return
                    if (err || response.error) {
                        if (err.message.includes(notYet)) {
                            return 'transactiion is not yet mined'
                        }

                        callback(err || response.error)
                    }

                    const transaction = response.result;
                    clearInterval(checkInterval)
                    calledBack = true
                    callback(null, transaction)
                })
            }, 2000)
        }
        document.addEventListener('DOMContentLoaded', runMetaMask);
    </script>
</head>

<body id='messages'>

</body>